<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bot</title>

    <script type="text/javascript" src="../../../jsCommon/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../../jsCommon/jquery/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../../jsCommon/common.js"></script>
    <script type="text/javascript" src="../../../jsCommon/cypher.js"></script>
    <script type="text/javascript" src="../../../jsCommon/others/async.js"></script>

    <script>

        var paragraphEntitiesProxyUrl = "../../../paragraphEntitiesGraph";

        var proposedEntities = {};
        var MainController = {
            showSpinner: function () {
            }
        }
        $(function () {

            $("#sentenceXXX").keyup(function (event) {
                var char = event.which
                if (char == 32)
                    submitPlainTextQuestionToService()

            })


            analyze = function () {
                selectedEntities = {};
                $("#ProposedEntitiesDiv").html("");
                $("#SuggestedEntitiesDiv").html("");
                $("#SelectedEntitiesDiv").html("");
                $("#PathsResult").html("");
                $("#foundPaths").html("");

                submitPlainTextQuestionToService($("#sentence").val())
            }

            submitPlainTextQuestionToService = function (sentence) {

                function decodeHtml(html) {
                    var txt = document.createElement("textarea");
                    txt.innerHTML = html;
                    return txt.value;
                }

                sentence = decodeHtml(sentence);

                sentence = sentence.replace(/<[^>]*>/g, "")
                //    var sentence = encodeURIComponent(sentence);
                //    var serviceUrl = "http://server-ctg-neo-question.azurewebsites.net/question/";

                sentence = sentence.trim();
                var payload = {
                    extractEntitiesFromPlainTextQuestion: 1,
                    questionText: sentence
                };

                var payload = {
                    getSentenceEntityProposals: 1,
                    sentence: sentence
                };
                $.ajax({
                    type: "POST",
                    url: paragraphEntitiesProxyUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        processProposedEntities(data)


                        $("#question").val(JSON.stringify(data, null, 2));

                    }, error: function (err) {
                        alert(JSON.stringify(err, null, 2))

                    }
                })
            }


            $('#SelectedEntitiesDiv').droppable({
                drop: function (event, ui) {


                    var draggable = ui.draggable;
                    var offset = draggable.offset();
                    draggable.appendTo(this).offset(offset);
                    ui.draggable.css({'top': '', 'left': ''});

                    ui.draggable.append("<button onclick='removeEntityFromSelectedEntitiesDiv(" +  ui.draggable.attr('id')+ ")'>X</button>");


                    var selectedId = [];

                    $("#SelectedEntitiesDiv").children().each(function (child) {
                        selectedId.push(parseInt($(this).attr("id")));
                    })

                    showSuggestedEntities(selectedId);

                    //     $("#"+draggableId).detach().appendTo("#SelectedEntitiesDiv");


                }
            });


        })

        showSuggestedEntities = function (entityIds) {




            //   var cypher = "Match (n)-[:hasEntity]-(p:Paragraph)-[:hasEntity]-(m) where id(n)="+entityId+"  and id(m)<>"+entityId+" and n.subGraph=\"entitiesGraph3\"  return m, collect(p) as paragraphs limit 1000"
            var distance = parseInt($("#suggestionParagraphDistance").val());


            var payload = {

                getAssociatedEntitiesInsidePaths: 1,
                entityIds: JSON.stringify(entityIds),
                distance: distance
            };
            $.ajax({
                type: "POST",
                url: paragraphEntitiesProxyUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var nPaths = data.nPaths;
                    $("#foundPaths").html(nPaths)
                    var entityLabels = {};
                    data.entities.forEach(function (line) {
                        if (!entityLabels[line.label])
                            entityLabels[line.label] = [];
                        entityLabels[line.label].push(line);

                        proposedEntities[line.id] = {name: line.name, nParaGraphs: line.nParaGraphs, id: line.id, label: line.label}
                    })


                    var html = "";

                    for (var label in entityLabels) {
                        html += " <div class='entityLabelsDivs'><span class=" + label + "> " + label + "</span><br>"
                        var entitiesMatchingParagrahs = entityLabels[label];

                        entitiesMatchingParagrahs.forEach(function (entity) {

                            var entitySpan = "<span  id='" + entity.id + "" + "' class='draggableEntity " + label + "' >" + entity.name + "(" + entity.nParaGraphs+ ")</span>";
                            html += entitySpan
                        })
                        html += "</div>"

                    }

                    html += "</div>"
                    $("#SuggestedEntitiesDiv").html(html);
                    $(".draggableEntity").draggable();

                }, error: function (err) {
                    alert(JSON.stringify(err, null, 2))

                }
            })


            /*     var cypher = "Match (n)-[:hasEntity]-(p:Paragraph)-[:precede*0.." + distance + "]-(p2:Paragraph)-[:hasEntity]-(m) where id(n) in" + JSON.stringify(entityIds) + "  and  id(n)<>id(m) and n.subGraph=\"entitiesGraph3\"  return m, collect(p) as paragraphs limit 1000"
                 console.log(cypher);

                 Cypher.executeCypher(cypher, function (err, result) {
                     var x = result;
                     var entityLabels = {}
                     var entitiesMatchingParagrahs = []
                     result.forEach(function (line) {
                         var name = line.m.properties.name;
                         var nParaGraphs = line.paragraphs.length;
                         var id = line.m._id;
                         var label = line.m.labels[0]
                         if (!entityLabels[label])
                             entityLabels[label] = [];
                         entityLabels[label].push({name: name, nParaGraphs: nParaGraphs, id: id, label: label})

                     })

                     var html = "";
                     for (var label in entityLabels) {
                         html += " <div class='entityLabelsDivs'><span class=" + label + "> " + label + "</span><br>"
                         var entitiesMatchingParagrahs = entityLabels[label];
                         entitiesMatchingParagrahs.sort(function (a, b) {

                             if (a.nParaGraphs > b.nParaGraphs)
                                 return -1;
                             if (a.nParaGraphs < b.nParaGraphs)
                                 return 1;
                             return 0;

                         })


                         entitiesMatchingParagrahs.forEach(function (entity) {

                             var entitySpan = "<span id='" + entity.id + "" + "' class='draggableEntity " + label + "' >" + entity.name + "(" + entity.nParaGraphs + ")</span>";
                             html += entitySpan
                         })
                         html += "</div>"

                     }

                     html += "</div>"
                     $("#SuggestedEntitiesDiv").html(html);
                     $(".draggableEntity").draggable();

                 })*/


        }


        processProposedEntities = function (data) {

            var entitiesByLabel = {}
            data.forEach(function (entity) {
                var ancestors = entity.data.ancestors.split(";")
                var label = ancestors[0]
                var name = entity.data.concept;


                if (!entitiesByLabel[label])
                    entitiesByLabel[label] = [];
                entitiesByLabel[label].push(name)


            })
            $("#ProposedEntitiesDiv").html("");
            var html = "";


            var entityLabels = Object.keys(entitiesByLabel);
            async.eachSeries(entityLabels, function (entityLabel, callbackEach) {
                html += " <div class='entityLabelsDivs'><span class=" + entityLabel + "> " + entityLabel + "</span><br>"

                var ids = JSON.stringify(entitiesByLabel[entityLabel]);
                var cypher = "Match (n:" + entityLabel + ")--(p:Paragraph) where n.name in " + ids + " and n.subGraph=\"entitiesGraph3\"  return n, collect(p) as paragraphs limit 1000"
                console.log(cypher);
                Cypher.executeCypher(cypher, function (err, result) {
                    var x = result;
                    var entitiesMatchingParagrahs = []
                    result.forEach(function (line) {
                        var name = line.n.properties.name;
                        var nParaGraphs = line.paragraphs.length;
                        var id = line.n._id;
                        entitiesMatchingParagrahs.push({name: name, nParaGraphs: nParaGraphs, id: id})
                        proposedEntities[id] = {name: name, nParaGraphs: nParaGraphs, id: id, label: entityLabel}
                    })

                    entitiesMatchingParagrahs.sort(function (a, b) {

                        if (a.nParaGraphs > b.nParaGraphs)
                            return -1;
                        if (a.nParaGraphs < b.nParaGraphs)
                            return 1;
                        return 0;

                    })


                    entitiesMatchingParagrahs.forEach(function (entity) {

                        var entitySpan = "<span id='" + entity.id + "" + "' class='draggableEntity " + entityLabel + "' >" + entity.name + "(" + entity.nParaGraphs + ")</span>";
                        html += entitySpan
                    })
                    html += "</div>"

                    callbackEach();

                })


            }, function (err) {

                $("#ProposedEntitiesDiv").html(html);
                $('.draggableEntity').draggable({});
            })


        }

        removeEntityFromSelectedEntitiesDiv=function(id){
$("#"+id).remove();
        }


        getEntities = function () {

            var sentence = $("#sentence").val();


            var payload = {

                getSentenceEntityProposals: 1,
                sentence: sentence,

            };
            $.ajax({
                type: "POST",
                url: paragraphEntitiesProxyUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {

                    var xx = data;
                    $("#response").val(JSON.stringify(data.response, null, 2));

                }, error: function (err) {
                    alert(JSON.stringify(err, null, 2))

                }
            })


        }

        showSelectedPaths = function () {
            var entities = []
            $("#SelectedEntitiesDiv").children().each(function () {
                var id = parseInt($(this).attr("id"))
                var entity = proposedEntities[id]
                entities.push({
                    "entity_label": entity.label,
                    "entity_value": entity.name,
                    "entity_normalized_value": entity.name
                });




            })
            var question={
                "question_entities":entities,
                "question_nouns": [],
                "question_verbs": [
                ],
                "question_adjs":[],
                "format": "TotalQuestionService"
            };
            var options={
                "maxParagraphDistance": 2,
                "filterNouns": false,
                "filterAdjs": false,
                "filterVerbs": false,
                "expandToAllChapterParagraphs": false,
                "subGraph": "entitiesGraph3"
            }

            if($("#allChapterCbx").prop("checked")){
                options.expandToAllChapterParagraphs=true;
            }
            try {
                var payload = {

                    getParagraphsMatchingEntitiesAndWords: 1,
                    question: JSON.stringify(question),
                    options:  JSON.stringify(options),
                };
                $.ajax({
                    type: "POST",
                    url: paragraphEntitiesProxyUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {

                        $("#PathsResult").val(JSON.stringify(data.response, null, 2));

                    }, error: function (err) {
                        alert(JSON.stringify(err, null, 2))

                    }
                })


            }
            catch (err) {
                alert(err);
            }




        }


    </script>
    <style>
        #ProposedEntitiesDiv, #SuggestedEntitiesDiv {
            width: 500px;
            min-height: 400px;
            max-height: 800px;
            overflow: unset;
            background-color: #dddddd;
            border: #261803 solid 2px;
            border-radius: 10px;
        }

        #SelectedEntitiesDiv {
            width: 200px;
            min-height: 400px;

            background-color: #dddddd;
            border: #261803 solid 2px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;

        }

        .entityLabelsDivs {
            width: 450px;
            padding: 5px;
            margin: 5px;
            border: #261803 solid 1px;
            border-radius: 5px;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .draggableEntity {
            border: solid 1px;
            font-style: normal;
            font-size: 12px;
            padding: 2px;
            margin: 2px;
            font-family: Verdana;
            border-radius: 2px;

        }
        #PathsResult{
            width: 800px;
            min-height: 400px;
            max-height: 800px;
            overflow: auto;
            background-color: #dddddd;
            border: #261803 solid 2px;
            border-radius: 10px;
        }

        .Equipment {

            background-color: #d9bb73;
        }

        .Phenomenon {
            background-color: #0f6848;

        }

        .Component {
            background-color: #1cc88a;

        }

        .Failure {
            background-color: #5bc0de;
        }

        .Characterisation {
            background-color: #c26629;
        }

        .Method {
            background-color: #6f42c1;
        }


    </style>

</head>
<body>


<input size="50" id="sentence" value="valve pressure surge">

<button onclick="analyze()">Analyze</button>

<table>


    <tr>

        <td>
            Sentence analysis

        </td>
        <td>
            Question

        </td>
        <td>
            Suggestions § distance<input id="suggestionParagraphDistance" size="2" value="2">

        </td>
    </tr>
    <tr>
        <td>
            <div id="ProposedEntitiesDiv" class="mainDivs"></div>

        </td>
        <td>
            <div id="SelectedEntitiesDiv" class="mainDivs"></div>
            paths found
            <span id="foundPaths"></span><input type="checkbox" id="allChapterCbx"> allChapter
                <button onclick="showSelectedPaths()"> OK</button>
        </td>

        <td>
            <div id="SuggestedEntitiesDiv" class="mainDivs"></div>

        </td>
    </tr>
    </tr>
    <tr>
        <td>


        </td>
    </tr>

    <tr>
        <td colspan="3">
            <textarea id="PathsResult"></textarea>

        </td>
    </tr>
</table>


</body>
</html>