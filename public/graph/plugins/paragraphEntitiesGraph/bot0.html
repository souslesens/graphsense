<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bot</title>

    <script type="text/javascript" src="../../../jsCommon/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../../jsCommon/jquery/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../../jsCommon/common.js"></script>
    <script type="text/javascript" src="../../../jsCommon/cypher.js"></script>
    <script type="text/javascript" src="../../../jsCommon/others/async.js"></script>

    <link rel="stylesheet" href="../../../jsCommon/others/jsTreeBootstrap/themes/default/style.min.css"/>
    <script src="../../../jsCommon/others/jsTreeBootstrap/jstree.min.js"></script>
    <script>

        var paragraphEntitiesProxyUrl = "../../../paragraphEntitiesGraph";
        var jsTreeObj = null;
        var proposedEntities = {};
        var proposedEntitiesNames = {}
        var MainController = {
            showSpinner: function () {
            }
        }
        $(function () {

            $("#sentenceXXX").keyup(function (event) {
                var char = event.which
                if (char == 32)
                    submitPlainTextQuestionToService()

            })


            analyze = function () {
                selectedEntities = {};
                $("#ProposedEntitiesDiv").html("");
                //    $("#SuggestedEntitiesDiv").html("");
                $("#SelectedEntitiesDiv").html("");
                $("#PathsResult").html("");
                $("#foundPaths").html("");
                $("#textDetailsDiv").text('');

                submitPlainTextQuestionToService($("#sentence").val())
            }

            submitPlainTextQuestionToService = function (sentence) {

                function decodeHtml(html) {
                    var txt = document.createElement("textarea");
                    txt.innerHTML = html;
                    return txt.value;
                }

                sentence = decodeHtml(sentence);

                sentence = sentence.replace(/<[^>]*>/g, "")
                //    var sentence = encodeURIComponent(sentence);
                //    var serviceUrl = "http://server-ctg-neo-question.azurewebsites.net/question/";

                sentence = sentence.trim();
                var payload = {
                    extractEntitiesFromPlainTextQuestion: 1,
                    questionText: sentence
                };

                var payload = {
                    getSentenceEntityProposals: 1,
                    sentence: sentence
                };
                $.ajax({
                    type: "POST",
                    url: paragraphEntitiesProxyUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        processProposedEntities(data.entities)
                        processProposedWords(data.words)


                        $("#question").val(JSON.stringify(data, null, 2));

                    }, error: function (err) {
                        alert(JSON.stringify(err, null, 2))

                    }
                })
            }


            $('.draggableEntity').bind("click", function () {
                var obj = $(this).detach();
                obj.appendTo($("#SelectedEntitiesDiv"));


                $(this).append("<button onclick='removeEntityFromSelectedEntitiesDiv(" + ui.draggable.attr('id') + ")'>X</button>");


                var selectedId = [];

                $("#SelectedEntitiesDiv").children().each(function (child) {
                    selectedId.push(parseInt($(this).attr("id")));
                })

                showSuggestedEntities(selectedId);


            })
            $('#SelectedEntitiesDiv').droppable({
                drop: function (event, ui) {


                    var draggable = ui.draggable;
                    var offset = draggable.offset();
                    draggable.appendTo(this).offset(offset);
                    ui.draggable.css({'top': '', 'left': ''});

                    ui.draggable.append("<button onclick='removeEntityFromSelectedEntitiesDiv(" + ui.draggable.attr('id') + ")'>X</button>");


                    var selectedId = [];

                    $("#SelectedEntitiesDiv").children().each(function (child) {
                        selectedId.push(parseInt($(this).attr("id")));
                    })

                    showSuggestedEntities(selectedId);
                    responseToJsTree([])

                    //     $("#"+draggableId).detach().appendTo("#SelectedEntitiesDiv");


                }
            });


        })

        showSuggestedEntities = function (entityIds) {

            if (entityIds.length == 0)
                analyze();


            //   var cypher = "Match (n)-[:hasEntity]-(p:Paragraph)-[:hasEntity]-(m) where id(n)="+entityId+"  and id(m)<>"+entityId+" and n.subGraph=\"entitiesGraph3\"  return m, collect(p) as paragraphs limit 1000"
            var distance = parseInt($("#suggestionParagraphDistance").val());


            var payload = {

                getAssociatedEntitiesInsidePaths: 1,
                entityIds: JSON.stringify(entityIds),
                distance: distance
            };
            $.ajax({
                type: "POST",
                url: paragraphEntitiesProxyUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var nPaths = data.nPaths;
                    $("#foundPaths").html(nPaths)
                    var entityLabels = {};
                    data.entities.forEach(function (line) {
                        if (entityIds.indexOf(line.id) < 0) {

                            if (!entityLabels[line.label])
                                entityLabels[line.label] = [];
                            entityLabels[line.label].push(line);

                            proposedEntities[line.id] = {name: line.name, nParaGraphs: line.nParaGraphs, id: line.id, label: line.label}
                        }
                    })


                    var html = "";

                    for (var label in entityLabels) {
                        html += " <div class='entityLabelsDivs'><span class=" + label + "> " + label + "</span><br>"
                        var entitiesMatchingParagrahs = entityLabels[label];

                        entitiesMatchingParagrahs.forEach(function (entity) {

                            var entitySpan = "<span  id='" + entity.id + "" + "' class='draggableEntity " + label + "' >" + entity.name + "(" + entity.nParaGraphs + ")</span>";
                            html += entitySpan
                        })
                        html += "</div>"

                    }

                    html += "</div>"
                    //  $("#SuggestedEntitiesDiv").html(html);
                    $("#ProposedEntitiesDiv").html(html);
                    $(".draggableEntity").draggable();

                }, error: function (err) {
                    alert(JSON.stringify(err, null, 2))

                }
            })


            /*     var cypher = "Match (n)-[:hasEntity]-(p:Paragraph)-[:precede*0.." + distance + "]-(p2:Paragraph)-[:hasEntity]-(m) where id(n) in" + JSON.stringify(entityIds) + "  and  id(n)<>id(m) and n.subGraph=\"entitiesGraph3\"  return m, collect(p) as paragraphs limit 1000"
                 console.log(cypher);

                 Cypher.executeCypher(cypher, function (err, result) {
                     var x = result;
                     var entityLabels = {}
                     var entitiesMatchingParagrahs = []
                     result.forEach(function (line) {
                         var name = line.m.properties.name;
                         var nParaGraphs = line.paragraphs.length;
                         var id = line.m._id;
                         var label = line.m.labels[0]
                         if (!entityLabels[label])
                             entityLabels[label] = [];
                         entityLabels[label].push({name: name, nParaGraphs: nParaGraphs, id: id, label: label})

                     })

                     var html = "";
                     for (var label in entityLabels) {
                         html += " <div class='entityLabelsDivs'><span class=" + label + "> " + label + "</span><br>"
                         var entitiesMatchingParagrahs = entityLabels[label];
                         entitiesMatchingParagrahs.sort(function (a, b) {

                             if (a.nParaGraphs > b.nParaGraphs)
                                 return -1;
                             if (a.nParaGraphs < b.nParaGraphs)
                                 return 1;
                             return 0;

                         })


                         entitiesMatchingParagrahs.forEach(function (entity) {

                             var entitySpan = "<span id='" + entity.id + "" + "' class='draggableEntity " + label + "' >" + entity.name + "(" + entity.nParaGraphs + ")</span>";
                             html += entitySpan
                         })
                         html += "</div>"

                     }

                     html += "</div>"
                     $("#SuggestedEntitiesDiv").html(html);
                     $(".draggableEntity").draggable();

                 })*/


        }

        processProposedWords = function (words) {

        }
        processProposedEntities = function (data) {

            var entitiesByLabel = {};
            var entitiesTree = {}
            data.forEach(function (entity) {
                if (entity.data && entity.data.ancestors) {
                    var ancestors = entity.data.ancestors.split(";")
                    ancestors.push(entity.data.concept)
                    var label = ancestors[0]


                    function recurseBuildTree(node, ancestors, level) {
                        if (level >= ancestors.length)
                            return node;

                        var ancestor = label + "_" + ancestors[level].replace(/ /g, "");
                        if (!node[ancestor])
                            node[ancestor] = {}
                        if (ancestors.length > 0)
                            recurseBuildTree(node[ancestor], ancestors, level + 1)
                        return node;
                    }

                    entitiesTree = recurseBuildTree(entitiesTree, ancestors, 0);


                    var name = entity.data.concept;


                    if (!entitiesByLabel[label])
                        entitiesByLabel[label] = [];
                    entitiesByLabel[label].push(name)
                }


            })


            $("#ProposedEntitiesDiv").html("");
            var html = "";


            var entityLabels = Object.keys(entitiesByLabel);
            async.eachSeries(entityLabels, function (entityLabel, callbackEach) {
                html += " <div class='entityLabelsDivs'><span style='height: 20px;font-weight: bold' class=" + entityLabel + "> " + entityLabel + "</span><br>"

                var ids = JSON.stringify(entitiesByLabel[entityLabel]);
                var cypher = "Match (n:" + entityLabel + ")--(p:Paragraph) where n.name in " + ids + " and n.subGraph=\"entitiesGraph3\"  return n, collect(p) as paragraphs limit 1000"
                console.log(cypher);
                Cypher.executeCypher(cypher, function (err, result) {
                    var x = result;
                    var entitiesMatchingParagrahs = []
                    result.forEach(function (line) {
                        var name = line.n.properties.name;
                        var nParaGraphs = line.paragraphs.length;
                        var id = line.n._id;
                        entitiesMatchingParagrahs.push({name: name, nParaGraphs: nParaGraphs, id: id})
                        proposedEntities[id] = {name: name, nParaGraphs: nParaGraphs, id: id, label: entityLabel}
                        proposedEntitiesNames[entityLabel + "_" + name.replace(/ /g, "")] = {name: name, nParaGraphs: nParaGraphs, id: id, label: entityLabel}
                    })

                    entitiesMatchingParagrahs.sort(function (a, b) {

                        if (a.nParaGraphs > b.nParaGraphs)
                            return -1;
                        if (a.nParaGraphs < b.nParaGraphs)
                            return 1;
                        return 0;

                    })


                    entitiesMatchingParagrahs.forEach(function (entity) {

                        var entitySpan = "<span id='" + entity.id + "" + "' class='draggableEntity " + entityLabel + "' >" + entity.name + "(" + entity.nParaGraphs + ")</span>";
                        html += entitySpan
                    })
                    html += "</div>"

                    callbackEach();

                })


            }, function (err) {


                $("#ProposedEntitiesDiv").html("");

                function recurseDrawEntitiesTree(node, domId, level) {

                    for (var entityName in node) {
                        var entityObj = node[entityName]
                        if (proposedEntitiesNames[entityName]) {
                            var entity = proposedEntitiesNames[entityName]

                            var entityDiv = "<div id='" + entity.id + "" + "' class='draggableEntity " + entity.label + "' >" + entity.name + "(" + entity.nParaGraphs + ")</div>";
                            $("#" + domId).append(entityDiv);
                            recurseDrawEntitiesTree(entityObj, entity.id, level + 1)
                        }
                        else {// label
                            if (level > 1)
                                var xxx = 1
                            var labelDiv = " <div id='" + entityName + "' class='entityLabelsDivs'><span class=" + entityName + "> " + entityName + "</span><br>"
                            $("#" + domId).append(labelDiv);
                            recurseDrawEntitiesTree(entityObj, entityName, level + 1)
                        }


                    }
                }


                 //  recurseDrawEntitiesTree(entitiesTree, "ProposedEntitiesDiv",0)

              $("#ProposedEntitiesDiv").append(html);
                $('.draggableEntity').draggable({});
            })


        }

        removeEntityFromSelectedEntitiesDiv = function (id) {

            $("#" + id).detach()

            var selectedIds = [];

            $("#SelectedEntitiesDiv").children().each(function (child) {
                var id = $(this).attr("id")
                selectedIds.push(parseInt(id));
            })
            showSuggestedEntities(selectedIds)
            responseToJsTree([]);
        }


        getEntities = function () {

            var sentence = $("#sentence").val();


            var payload = {

                getSentenceEntityProposals: 1,
                sentence: sentence,

            };
            $.ajax({
                type: "POST",
                url: paragraphEntitiesProxyUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {

                    var xx = data;
                    $("#response").val(JSON.stringify(data.response, null, 2));

                }, error: function (err) {
                    alert(JSON.stringify(err, null, 2))

                }
            })


        }

        showSelectedPaths = function () {
            var entities = []
            $("#SelectedEntitiesDiv").children().each(function () {
                var id = parseInt($(this).attr("id"));
                var entity = proposedEntities[id]
                entities.push({
                    "entity_label": entity.label,
                    "entity_value": entity.name,
                    "entity_normalized_value": entity.name
                });


            })
            var question = {
                "question_entities": entities,
                "question_nouns": [],
                "question_verbs": [],
                "question_adjs": [],
                "format": "TotalQuestionService"
            };
            var options = {
                "maxParagraphDistance": 2,
                "filterNouns": false,
                "filterAdjs": false,
                "filterVerbs": false,
                "expandToAllChapterParagraphs": false,
                "subGraph": "entitiesGraph3"
            }

            if ($("#allChapterCbx").prop("checked")) {
                options.expandToAllChapterParagraphs = true;
            }
            try {
                var payload = {

                    getParagraphsMatchingEntitiesAndWords: 1,
                    question: JSON.stringify(question),
                    options: JSON.stringify(options),
                };
                $.ajax({
                    type: "POST",
                    url: paragraphEntitiesProxyUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        $("#PathsResult").val(JSON.stringify(data.response, null, 2));
                        // responseToJsTree(data.response);
                        responseToCards(data.response);



                    }, error: function (err) {
                        alert(JSON.stringify(err, null, 2))

                    }
                })


            }
            catch (err) {
                alert(err);
            }


        }


        responseToCards = function (response) {


            $("#jstreeResult").html("");
            var index = 0;
            var pathIndex=0
            function recurseDrawResponse(node, domId, level) {

                if (Array.isArray(node)) {
                    var id;
                        node.forEach(function (line, index) {

                        var text = "";
                        if (level == 3) {//path
                           var idPath ="Path_"+(pathIndex++);
                            text="path"+(index+1)
                            var html = "<div class=' cardResponseDiv' id='" + idPath + "'> " + text + "</div>";
                            $("#" + domId).append(html);
                            line.forEach(function (paragraph, index2) {
                                var idParagraph = paragraph.id
                                text=paragraph.text;
                                var html = "<div class=' cardResponseDiv' id='" + idParagraph + "'> " + text + "</div>";
                                $("#" + idPath).append(html);
                            })
                        //    recurseDrawResponse(line, id, level + 1);
                           index++;
                        }







                    })



                }
                else if (typeof node == "object") {

                    for (var key in node) {
                        if (true || level == 0) {//entities
                            var id = (level + "_" + index)
                            var text = ""

                            if (level == 0)//entities
                                text = key;
                            if (level == 1)//document
                                text = key;
                            if (level == 2)//chapter
                                text = key;

                            var html = "<div class=' cardResponseDiv' id='" + id + "'> " + key + "</div>";
                            $("#" + domId).append(html);

                            var childNode = node[key];
                            if (level == 0)//document
                                childNode = node[key].documents
                            if (level == 1)//
                                childNode = node[key].chapters;
                            if (level == 2)//chapter
                                childNode = node[key].paths;

                            recurseDrawResponse(childNode, id, level + 1)
                        }

                    }


                }
                index++;


            }

            recurseDrawResponse(response, "jstreeResult", 0);


        }
        responseToJsTree = function (response) {
            return;
            var treeJsonArray = []
            response.forEach(function (chapter) {
                var chapterId = chapter.location.chapterId
                treeJsonArray.push({id: chapterId, text: chapterId, parent: "#"});
                chapter.entities.forEach(function (entities, entitiesIndex) {
                    var entityText = "";
                    entities.entities.forEach(function (entity, entityIndex) {
                        if (entityIndex > 0)
                            entityText += "-"
                        entityText = "[" + entity.label + "]" + entity.value;
                    })
                    treeJsonArray.push({id: chapterId + "_" + entitiesIndex, text: entityText, parent: chapterId});
                    entities.paragraphs.forEach(function (paragraph) {
                        treeJsonArray.push({id: chapterId + "_" + entitiesIndex + "_" + paragraph.id, text: paragraph.text, parent: chapterId + "_" + entitiesIndex});


                    })


                })


            })

            if (jsTreeObj) {

                $('#jstreeResult').jstree(true).settings.core.data = treeJsonArray;
                // $('#jstreeResult').jstree(true).redraw(true)
                $('#jstreeResult').jstree().refresh()


            } else {


                jsTreeObj = $("#jstreeResult").jstree({
                    'core': {
                        'data': treeJsonArray
                    }
                }).on('loaded.jstree', function () {
                    $("#jstreeResult").jstree('open_all');
                }).on('refresh.jstree', function () {
                    $("#jstreeResult").jstree('open_all');
                }).on("select_node.jstree", function (evt, obj) {
                    var text = obj.node.text
                    $("#textDetailsDiv").text(text);
                })

                ;
            }
        }

    </script>
    <style>
        #ProposedEntitiesDiv, #SuggestedEntitiesDiv, SelectedEntitiesDiv {
            width: 500px;
            min-height: 400px;
            max-height: 800px;
            overflow: unset;
            background-color: #dddddd;
            border: #261803 solid 2px;
            border-radius: 10px;
          //  display: flex;
            flex-flow: row wrap;
        }

        #SelectedEntitiesDiv {

            min-height: 100px;

            background-color: #dddddd;
            border: #261803 solid 2px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            display: flex;
            flex-flow: column wrap;

        }

        .entityLabelsDivsXXX {
            max-width: 200px;
            padding: 5px;
            margin: 5px;
            border: #261803 solid 1px;
            border-radius: 5px;

        }
        .entityLabelsDivs{
            width: 450px;
            padding: 5px;
            margin: 5px;
            border: #261803 solid 1px;
            border-radius: 5px;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .draggableEntity {
            height: 20px;
            border: solid 1px;
            font-style: normal;
            font-size: 12px;
            padding: 2px;
            margin: 2px;
            font-family: Verdana;
            border-radius: 10px;

        }


        #PathsResult {
            width: 800px;
            min-height: 400px;
            max-height: 800px;
            overflow: auto;
            background-color: #dddddd;
            border: #261803 solid 2px;
            border-radius: 10px;
        }

        .Equipment {

            background-color: #d9bb73;
        }

        .Phenomenon {
            background-color: #0f6848;

        }

        .Component {
            background-color: #1cc88a;

        }

        .Failure {
            background-color: #5bc0de;
        }

        .Characterisation {
            background-color: #c26629;
        }

        .Method {
            background-color: #6f42c1;
        }

        .cardResponseDiv{
            margin-left: 5px;
            margin: 2px;
            padding: 5px;
            border: #d3cccc 1px solid;
            padding-top: 5px;
            border-radius: 10px;
        }


    </style>

</head>
<body>


<input size="50" id="sentence" value="valve pressure surge">

<button onclick="analyze()">Analyze</button>

<table>


    <tr valign="top">
        <td>
            Proposed Entities (drag)
            <div id="ProposedEntitiesDiv" class="mainDivs"></div>

            <div id="textDetailsDiv"></div>

        </td>


        <td>

            Selected Entities (drop)
            <div id="SelectedEntitiesDiv" class="mainDivs"></div>

            <div style="background-color: #ddd;border: solid #261803 1px;width: 600px;padding: 3px">
                § distance<input id="suggestionParagraphDistance" size="2" value="2"><br>
                paths found<span id="foundPaths" style="font-size: 18px;font-weight: bold"></span>
                <button onclick="showSelectedPaths()">Show paragraphs</button>
             <!--   <input type="checkbox" id="allChapterCbx"> All Chapter Paragrpahs-->
            </div>
            <div id="jstreeResult" class="mainDivs" style="width: 500px; height: 500px;overflow: auto"></div>
        </td>

    </tr>
    </tr>
    <tr>
        <td>


        </td>
    </tr>

    <tr>
        <td colspan="3">

            <textarea id="PathsResult"></textarea>

        </td>
    </tr>
</table>


</body>
</html>